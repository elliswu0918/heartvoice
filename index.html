<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HeartVoice Care</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chat-bubble { max-width: 70%; padding: 1rem; border-radius: 0.5rem; margin: 0.5rem 0; }
    .user-message { background-color: #2563eb; color: white; margin-left: auto; }
    .assistant-message { background-color: white; color: #1f2937; }
    .thinking { padding: 1rem; border-radius: 0.5rem; background-color: #f3f4f6; color: #6b7280; display: inline-block; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-white min-h-screen">
  <div id="home-page" class="container mx-auto px-4 py-16 text-center">
    <h1 class="text-4xl font-bold text-gray-900 mb-4">HeartVoice Care</h1>
    <p class="text-xl text-gray-600 mb-6">ä¸€å€‹æº«æš–ã€æ”¯æŒæ€§çš„ AI è«®å•†å¤¥ä¼´ï¼Œéš¨æ™‚å‚¾è½æ‚¨çš„å¿ƒè²</p>
    <button id="startButton" class="bg-blue-600 text-white px-8 py-3 rounded-full text-lg font-semibold hover:bg-blue-700">é–‹å§‹è«®å•†</button>
  </div>

  <div id="chat-page" class="hidden flex h-screen">
    <div class="flex-1 flex flex-col">
      <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      <div class="p-4 border-t bg-white">
        <div class="flex">
            <input id="textInput" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„è¨Šæ¯..." class="flex-1 border rounded p-2" />
            <button id="sendButton" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded">ç™¼é€</button>
            <button id="recordButton" class="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center">ğŸ™</button>
        </div>
      </div>
    </div>
    <div class="w-80 bg-white border-l p-4 overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">æƒ…ç·’åˆ†æ</h2>
      <canvas id="emotionChart" class="h-64 mb-4"></canvas>
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-green-50 p-2 rounded"><span class="text-green-700">é–‹å¿ƒ:</span> <span id="happyScore">0%</span></div>
        <div class="bg-red-50 p-2 rounded"><span class="text-red-700">æ†‚å‚·:</span> <span id="sadScore">0%</span></div>
        <div class="bg-yellow-50 p-2 rounded"><span class="text-yellow-700">ç„¦æ…®:</span> <span id="anxiousScore">0%</span></div>
        <div class="bg-blue-50 p-2 rounded"><span class="text-blue-700">å¹³éœ:</span> <span id="calmScore">0%</span></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("startButton").addEventListener("click", startChat);
      document.getElementById("recordButton").addEventListener("click", toggleRecording);
      document.getElementById("sendButton").addEventListener("click", sendTextInput);
      document.getElementById("textInput").addEventListener("keypress", function(event) {
          if (event.key === "Enter") {
              sendTextInput(); // æŒ‰ä¸‹ Enter éµæ™‚ç™¼é€æ¶ˆæ¯
          }
      });
    });

    let isRecording = false;
    let chart;
    let conversationHistory = [{
        role: "system",
        content: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†è«®å•†å¸«ï¼Œæ“…é•·ä»¥åŒç†å¿ƒå’Œæ”¯æŒæ€§çš„æ–¹å¼èˆ‡ä¾†è¨ªè€…å°è©±ã€‚è«‹éµå¾ªä»¥ä¸‹åŸå‰‡ï¼š

            1. ä½¿ç”¨æº«å’Œã€å¹³éœçš„èªæ°£
            2. å±•ç¾ç©æ¥µå‚¾è½å’ŒåŒç†å¿ƒ
            3. é¿å…ç›´æ¥çµ¦å»ºè­°ï¼Œè€Œæ˜¯å¼•å°ä¾†è¨ªè€…è‡ªæˆ‘æ¢ç´¢
            4. ä½¿ç”¨é–‹æ”¾å¼å•é¡Œé¼“å‹µä¾†è¨ªè€…è¡¨é”
            5. é©æ™‚åæ˜ ä¾†è¨ªè€…çš„æƒ…ç·’
            6. ä¿æŒå°ˆæ¥­ç•Œé™
            7. æ³¨æ„ä¾†è¨ªè€…çš„æƒ…ç·’è®ŠåŒ–
            8. åœ¨é©ç•¶æ™‚æ©Ÿåšæ‘˜è¦èˆ‡çµ±æ•´

            æ¯æ¬¡å›æ‡‰è«‹æ§åˆ¶åœ¨100å­—ä»¥å…§ï¼Œä½¿ç”¨æº«æš–ä¸”å°ˆæ¥­çš„å£å»ã€‚`
    }];

    const synth = window.speechSynthesis;
    let speaking = false;
    let recognition;

    function initializeSpeechRecognition() {
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onresult = (event) => {
                const userMessage = event.results[0][0].transcript;
                addMessage('user', userMessage);
                updateEmotionData();

                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'flex justify-start';
                thinkingDiv.innerHTML = '<div class="thinking">æ€è€ƒä¸­...</div>';
                document.getElementById('chat-messages').appendChild(thinkingDiv);

                getLocalModelResponse(userMessage).then(response => {
                    thinkingDiv.remove();
                    addMessage('assistant', response);
                    speak(response);
                }).catch(error => {
                    console.error('Error in toggleRecording:', error);
                    thinkingDiv.remove();
                    addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                });
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
            };
        } else {
            alert('æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³è­˜åˆ¥ã€‚');
        }
    }

    function toggleRecording() {
        const button = document.getElementById('recordButton');
        isRecording = !isRecording;

        if (isRecording) {
            button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            button.classList.add('bg-red-500', 'hover:bg-red-600');
            recognition.start();
        } else {
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-blue-600', 'hover:bg-blue-700');
            recognition.stop();
        }
    }

    document.addEventListener('DOMContentLoaded', initializeSpeechRecognition);

    function speak(text){
      if(speaking) synth.cancel();
      const utter=new SpeechSynthesisUtterance(text);
      utter.lang='zh-TW'; utter.rate=0.9; utter.pitch=1; utter.volume=1;
      const voice=synth.getVoices().find(v=>v.lang.includes('zh'));
      if(voice) utter.voice=voice;
      speaking=true; synth.speak(utter);
      utter.onend=()=>speaking=false;
    }

    function startChat(){
      document.getElementById('home-page').classList.add('hidden');
      document.getElementById('chat-page').classList.remove('hidden');
      initChart();
    }

    function initChart(){
      const ctx=document.getElementById('emotionChart').getContext('2d');
      chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
        {label:'é–‹å¿ƒ',data:[],borderColor:'rgb(34,197,94)',tension:0.4},
        {label:'æ†‚å‚·',data:[],borderColor:'rgb(239,68,68)',tension:0.4},
        {label:'ç„¦æ…®',data:[],borderColor:'rgb(234,179,8)',tension:0.4},
        {label:'å¹³éœ',data:[],borderColor:'rgb(59,130,246)',tension:0.4}
      ]},options:{responsive:true,scales:{y:{beginAtZero:true,max:1}}}});
    }

    async function getLocalModelResponse(userMsg) {
        const prompt = `
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å¿ƒç†è«®å•†å¸«ï¼Œæ“…é•·ä»¥åŒç†å¿ƒå’Œæ”¯æŒæ€§çš„æ–¹å¼èˆ‡ä¾†è¨ªè€…å°è©±ã€‚
è«‹éµå¾ªä»¥ä¸‹åŸå‰‡ï¼š
1. ä½¿ç”¨æº«å’Œã€å¹³éœçš„èªæ°£
2. å±•ç¾ç©æ¥µå‚¾è½å’ŒåŒç†å¿ƒ
3. é¿å…ç›´æ¥çµ¦å»ºè­°ï¼Œè€Œæ˜¯å¼•å°ä¾†è¨ªè€…è‡ªæˆ‘æ¢ç´¢
4. ä½¿ç”¨é–‹æ”¾å¼å•é¡Œé¼“å‹µä¾†è¨ªè€…è¡¨é”
5. é©æ™‚åæ˜ ä¾†è¨ªè€…çš„æƒ…ç·’
6. ä¿æŒå°ˆæ¥­ç•Œé™
7. æ³¨æ„ä¾†è¨ªè€…çš„æƒ…ç·’è®ŠåŒ–
8. åœ¨é©ç•¶æ™‚æ©Ÿåšæ‘˜è¦èˆ‡çµ±æ•´

æ¯æ¬¡å›æ‡‰è«‹æ§åˆ¶åœ¨100å­—ä»¥å…§ï¼Œä½¿ç”¨æº«æš–ä¸”å°ˆæ¥­çš„å£å»ã€‚

ä»¥ä¸‹æ˜¯ä¾†è¨ªè€…çš„æå•ï¼š${userMsg}
`;

        try {
            const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyCq_cLijJCx4DszzypqYeTmyhy1bJ0U4HA", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();
            console.log("API éŸ¿æ‡‰ï¼š", data);

            const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            return reply || "ç›®å‰ç„¡æ³•å–å¾— Gemini æ¨¡å‹å›æ‡‰ã€‚";
        } catch (e) {
            console.error("Gemini API éŒ¯èª¤ï¼š", e);
            return "å‘¼å« Gemini æ¨¡å‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

    function addMessage(role, content) {
        const div = document.createElement('div');
        div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        const bub = document.createElement('div');
        bub.className = `chat-bubble ${role === 'user' ? 'user-message' : 'assistant-message'}`;
        bub.textContent = content;
        div.appendChild(bub);
        document.getElementById('chat-messages').appendChild(div);
    }

    function updateEmotionData() {
        // å‡è¨­é€™è£¡æœ‰ä¸€äº›é‚è¼¯ä¾†æ›´æ–°æƒ…ç·’æ•¸æ“š
        const happyScore = Math.random(); // ç¤ºä¾‹æ•¸æ“š
        const sadScore = Math.random();   // ç¤ºä¾‹æ•¸æ“š
        const anxiousScore = Math.random(); // ç¤ºä¾‹æ•¸æ“š
        const calmScore = Math.random();   // ç¤ºä¾‹æ•¸æ“š

        // æ›´æ–°æƒ…ç·’åˆ†æ•¸çš„é¡¯ç¤º
        document.getElementById("happyScore").textContent = (happyScore * 100).toFixed(0) + "%";
        document.getElementById("sadScore").textContent = (sadScore * 100).toFixed(0) + "%";
        document.getElementById("anxiousScore").textContent = (anxiousScore * 100).toFixed(0) + "%";
        document.getElementById("calmScore").textContent = (calmScore * 100).toFixed(0) + "%";

        // æ›´æ–°åœ–è¡¨æ•¸æ“š
        chart.data.labels.push(new Date().toLocaleTimeString()); // æ·»åŠ æ™‚é–“æ¨™ç±¤
        chart.data.datasets[0].data.push(happyScore); // é–‹å¿ƒ
        chart.data.datasets[1].data.push(sadScore);    // æ†‚å‚·
        chart.data.datasets[2].data.push(anxiousScore); // ç„¦æ…®
        chart.data.datasets[3].data.push(calmScore);    // å¹³éœ
        chart.update(); // æ›´æ–°åœ–è¡¨
    }

    function sendTextInput() {
        const userMessage = document.getElementById("textInput").value.trim();
        console.log("ç”¨æˆ¶è¼¸å…¥çš„æ¶ˆæ¯ï¼š", userMessage);
        if (userMessage) {
            addMessage('user', userMessage);
            updateEmotionData();

            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'flex justify-start';
            thinkingDiv.innerHTML = '<div class="thinking">æ€è€ƒä¸­...</div>';
            document.getElementById('chat-messages').appendChild(thinkingDiv);

            getLocalModelResponse(userMessage).then(response => {
                thinkingDiv.remove();
                addMessage('assistant', response);
                speak(response);
            }).catch(error => {
                console.error('Error in sendTextInput:', error);
                thinkingDiv.remove();
                addMessage('assistant', 'æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });

            document.getElementById("textInput").value = '';
        }
    }
  </script>
</body>
</html>
